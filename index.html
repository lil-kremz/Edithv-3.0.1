<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EDITH - AI Assistant</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      /* Dark Theme Colors */
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --primary-light: #3b82f6;
      --dark-1: #0f172a;
      --dark-2: #1e293b;
      --dark-3: #334155;
      --light-1: #f8fafc;
      --light-2: #e2e8f0;
      --light-3: #cbd5e1;
      --text-light: #f1f5f9;
      --text-dark: #0f172a;
      --text-dim: #94a3b8;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --border-radius: 12px;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Light Theme Colors */
    [data-theme="light"] {
      --dark-1: #ffffff;
      --dark-2: #f1f5f9;
      --dark-3: #e2e8f0;
      --light-1: #0f172a;
      --light-2: #1e293b;
      --light-3: #334155;
      --text-light: #0f172a;
      --text-dark: #f1f5f9;
      --text-dim: #64748b;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    @font-face {
      font-family: 'Inter';
      font-style: normal;
      font-weight: 400;
      font-display: swap;
      src: url('https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZ9hiA.woff2') format('woff2');
    }

    @font-face {
      font-family: 'Inter';
      font-style: normal;
      font-weight: 600;
      font-display: swap;
      src: url('https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuGKYAZ9hiA.woff2') format('woff2');
    }

    body {
      background-color: var(--dark-1);
      color: var(--text-light);
      display: flex;
      height: 100vh;
      overflow: hidden;
      transition: var(--transition);
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background-color: var(--dark-2);
      border-right: 1px solid var(--dark-3);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 20;
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
    }

    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--dark-3);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .sidebar-header h2 {
      color: var(--text-light);
      font-size: 1.25rem;
      font-weight: 600;
      letter-spacing: -0.025em;
    }

    .sidebar-menu {
      flex: 1;
      overflow-y: auto;
      padding: 0.75rem 0;
    }

    .menu-section {
      margin-bottom: 1.5rem;
    }

    .menu-section h3 {
      padding: 0.5rem 1.5rem;
      color: var(--text-dim);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .menu-item {
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      transition: var(--transition);
      color: var(--text-light);
      font-size: 0.9375rem;
      font-weight: 500;
    }

    .menu-item:hover {
      background-color: var(--dark-3);
    }

    .menu-item.active {
      background-color: var(--dark-3);
      border-left: 3px solid var(--primary);
    }

    .menu-item i {
      width: 1.25rem;
      text-align: center;
      color: var(--text-dim);
    }

    .menu-item.active i {
      color: var(--primary);
    }

    .sidebar-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--dark-3);
      font-size: 0.75rem;
      color: var(--text-dim);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      margin-left: 280px;
      transition: var(--transition);
    }

    /* Overlay for mobile */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 15;
      display: none;
    }

    /* Header */
    .header {
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--dark-3);
      background-color: var(--dark-2);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .menu-toggle {
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 1.2rem;
      cursor: pointer;
      display: none;
    }

    .header-title h1 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-light);
      letter-spacing: -0.025em;
    }

    .header-actions {
      display: flex;
      gap: 0.75rem;
    }

    .header-btn {
      padding: 0.5rem 1rem;
      background-color: var(--dark-3);
      border: none;
      border-radius: var(--border-radius);
      color: var(--text-light);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: var(--transition);
    }

    .header-btn:hover {
      background-color: var(--primary);
    }

    /* Voice input indicator */
    .voice-active {
      background-color: var(--error) !important;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    /* Chat Area */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background-color: var(--dark-1);
    }

    .chat-area {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .message {
      max-width: 80%;
      padding: 1rem 1.25rem;
      border-radius: var(--border-radius);
      line-height: 1.5;
      position: relative;
      animation: fadeIn 0.2s ease-out;
      font-size: 0.9375rem;
      box-shadow: var(--shadow-sm);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .user-message {
      align-self: flex-end;
      background-color: var(--primary);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .ai-message {
      align-self: flex-start;
      background-color: var(--dark-2);
      color: var(--text-light);
      border-bottom-left-radius: 4px;
    }

    .message-content {
      line-height: 1.6;
    }

    .message-content a {
      color: var(--primary);
      text-decoration: none;
    }

    .message-content a:hover {
      text-decoration: underline;
    }

    .message-content code {
      background-color: var(--dark-3);
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-family: monospace;
    }

    .message-time {
      font-size: 0.75rem;
      color: var(--text-dim);
      margin-top: 0.5rem;
      text-align: right;
    }

    .typing-indicator {
      display: inline-flex;
      gap: 0.25rem;
      align-items: center;
      padding-left: 0.5rem;
    }

    .typing-dot {
      height: 8px;
      width: 8px;
      background-color: var(--text-dim);
      border-radius: 50%;
      opacity: 0.4;
    }

    .typing-dot:nth-child(1) {
      animation: typing 1s infinite;
    }

    .typing-dot:nth-child(2) {
      animation: typing 1s infinite 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation: typing 1s infinite 0.4s;
    }

    @keyframes typing {
      0% { opacity: 0.4; transform: translateY(0); }
      50% { opacity: 1; transform: translateY(-2px); }
      100% { opacity: 0.4; transform: translateY(0); }
    }

    /* Input Area */
    .input-area {
      padding: 1rem 1.5rem;
      background-color: var(--dark-2);
      border-top: 1px solid var(--dark-3);
      display: flex;
      gap: 0.75rem;
      position: sticky;
      bottom: 0;
    }

    .input-field {
      flex: 1;
      padding: 0.875rem 1.25rem;
      background-color: var(--dark-3);
      border: 1px solid var(--dark-3);
      border-radius: var(--border-radius);
      color: var(--text-light);
      font-size: 0.9375rem;
      outline: none;
      transition: var(--transition);
      line-height: 1.5;
    }

    .input-field:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }

    .send-btn {
      width: 48px;
      height: 48px;
      border-radius: var(--border-radius);
      background-color: var(--primary);
      border: none;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .send-btn:hover {
      background-color: var(--primary-dark);
    }

    .send-btn:disabled {
      background-color: var(--dark-3);
      cursor: not-allowed;
    }

    /* Knowledge Panel */
    .knowledge-panel {
      position: fixed;
      right: 1.5rem;
      top: 5.5rem;
      width: 320px;
      background-color: var(--dark-2);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--dark-3);
      z-index: 15;
      transform: translateX(120%);
      transition: var(--transition);
      padding: 1.25rem;
      max-height: calc(100vh - 7rem);
      overflow-y: auto;
    }

    .knowledge-panel.active {
      transform: translateX(0);
    }

    .knowledge-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--dark-3);
    }

    .knowledge-header h3 {
      color: var(--text-light);
      font-size: 1rem;
      font-weight: 600;
    }

    .close-panel {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 1.25rem;
      cursor: pointer;
      padding: 0.25rem;
    }

    .knowledge-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }

    .stat-item {
      background-color: var(--dark-3);
      padding: 0.75rem;
      border-radius: var(--border-radius);
      text-align: center;
    }

    .stat-value {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-dim);
    }

    .progress-container {
      margin-bottom: 1.25rem;
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.8125rem;
      color: var(--text-dim);
    }

    .progress-bar {
      height: 6px;
      background-color: var(--dark-3);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background-color: var(--primary);
      width: 0%;
      transition: width 0.3s ease;
    }

    .knowledge-list {
      max-height: 240px;
      overflow-y: auto;
    }

    .knowledge-item {
      padding: 0.75rem;
      background-color: var(--dark-3);
      border-radius: var(--border-radius);
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      color: var(--text-light);
    }

    /* Web Result Card */
    .web-result {
      background-color: var(--dark-3);
      border-radius: var(--border-radius);
      padding: 1rem;
      margin-bottom: 1rem;
      border-left: 3px solid var(--primary);
    }

    .web-result-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--primary);
    }

    .web-result-url {
      font-size: 0.75rem;
      color: var(--text-dim);
      margin-bottom: 0.5rem;
      word-break: break-all;
    }

    .web-result-desc {
      font-size: 0.875rem;
      line-height: 1.5;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      .menu-toggle {
        display: block;
      }
      
      .knowledge-panel {
        width: calc(100% - 3rem);
        right: 1.5rem;
        left: 1.5rem;
      }
      
      .message {
        max-width: 85%;
      }
      
      .sidebar.active + .overlay {
        display: block;
      }
    }

    @media (max-width: 768px) {
      .header-title h1 {
        font-size: 1.125rem;
      }
      
      .header-btn span {
        display: none;
      }
      
      .header-btn {
        padding: 0.5rem;
        width: 40px;
        height: 40px;
        justify-content: center;
      }
      
      .message {
        max-width: 90%;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <i class="fas fa-robot" style="color: var(--primary);"></i>
      <h2>EDITH AI</h2>
    </div>
    
    <div class="sidebar-menu">
      <div class="menu-section">
        <h3>Navigation</h3>
        <div class="menu-item active" data-panel="chat">
          <i class="fas fa-comment-dots"></i>
          <span>Chat</span>
        </div>
        <div class="menu-item" data-panel="knowledge">
          <i class="fas fa-brain"></i>
          <span>Knowledge Base</span>
        </div>
        <div class="menu-item" data-panel="stats">
          <i class="fas fa-chart-line"></i>
          <span>Analytics</span>
        </div>
      </div>
      
      <div class="menu-section">
        <h3>Commands</h3>
        <div class="menu-item" onclick="insertCommand('help')">
          <i class="fas fa-question-circle"></i>
          <span>Help</span>
        </div>
        <div class="menu-item" onclick="insertCommand('list')">
          <i class="fas fa-list"></i>
          <span>List Knowledge</span>
        </div>
        <div class="menu-item" onclick="insertCommand('joke')">
          <i class="fas fa-laugh-squint"></i>
          <span>Tell a Joke</span>
        </div>
      </div>
      
      <div class="menu-section">
        <h3>Settings</h3>
        <div class="menu-item" id="themeToggle" onclick="toggleTheme()">
          <i class="fas fa-moon"></i>
          <span>Dark Mode</span>
        </div>
        <div class="menu-item" onclick="clearChat()">
          <i class="fas fa-trash"></i>
          <span>Clear Chat</span>
        </div>
      </div>
    </div>
    
    <div class="sidebar-footer">
      <p>EDITH AI v3.0</p>
      <p>All data stored locally</p>
    </div>
  </div>

  <!-- Overlay for closing sidebar -->
  <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <button class="menu-toggle" onclick="toggleSidebar()">
          <i class="fas fa-bars"></i>
        </button>
        <div class="header-title">
          <h1>EDITH AI Assistant</h1>
        </div>
      </div>
      
      <div class="header-actions">
        <button class="header-btn" onclick="toggleKnowledgePanel()">
          <i class="fas fa-chart-pie"></i>
          <span>Stats</span>
        </button>
        <button class="header-btn" id="voiceBtn" onclick="startVoiceInput()">
          <i class="fas fa-microphone"></i>
          <span>Voice</span>
        </button>
      </div>
    </div>
    
    <!-- Chat Area -->
    <div class="chat-container">
      <div class="chat-area" id="chatArea">
        <div class="ai-message">
          <div class="message-content">
            Welcome to EDITH AI v3.0. I'm your advanced artificial intelligence assistant. 
            How can I help you today?
          </div>
          <div class="message-time">Just now</div>
        </div>
        
        <div class="ai-message">
          <div class="message-content">
            <strong>New Features:</strong><br><br>
            • Web search capability (use <code>search: your query</code>)<br>
            • Improved knowledge base<br>
            • Enhanced UI with better theme support<br>
            • Voice input improvements
          </div>
          <div class="message-time">Just now</div>
        </div>
      </div>
      
      <!-- Input Area -->
      <div class="input-area">
        <input type="text" class="input-field" id="userInput" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
        <button class="send-btn" id="sendBtn" onclick="respond()">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Knowledge Panel -->
  <div class="knowledge-panel" id="knowledgePanel">
    <div class="knowledge-header">
      <h3>Knowledge Analytics</h3>
      <button class="close-panel" onclick="toggleKnowledgePanel()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="knowledge-stats">
      <div class="stat-item">
        <div class="stat-value" id="statKnowledge">0</div>
        <div class="stat-label">Knowledge Items</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="statInteractions">0</div>
        <div class="stat-label">Interactions</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="statStreak">0</div>
        <div class="stat-label">Day Streak</div>
      </div>
    </div>
    
    <div class="progress-container">
      <div class="progress-label">
        <span>Learning Progress</span>
        <span id="progressPercent">0%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>
    
    <div class="knowledge-list" id="knowledgeList">
      <!-- Knowledge items will be added here dynamically -->
    </div>
  </div>

  <script>
    // EDITH AI Core Functionality
    let brain = JSON.parse(localStorage.getItem('edithBrain')) || {};
    let stats = JSON.parse(localStorage.getItem('edithStats')) || {
      knowledge: 0,
      interactions: 0,
      streak: 0,
      lastInteraction: null,
      webQueries: 0
    };
    let isTyping = false;
    let recognition = null;
    let isListening = false;
    
    // DOM Elements
    const sidebar = document.getElementById('sidebar');
    const knowledgePanel = document.getElementById('knowledgePanel');
    const themeToggle = document.getElementById('themeToggle');
    const overlay = document.getElementById('overlay');
    const mainContent = document.getElementById('mainContent');
    const voiceBtn = document.getElementById('voiceBtn');
    const sendBtn = document.getElementById('sendBtn');
    const userInput = document.getElementById('userInput');
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Set initial theme from localStorage or prefer-color-scheme
      const savedTheme = localStorage.getItem('edithTheme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      if (savedTheme === 'light' || (!savedTheme && !prefersDark)) {
        document.body.setAttribute('data-theme', 'light');
      } else {
        document.body.setAttribute('data-theme', 'dark');
      }
      updateThemeIcon();
      
      updateStatsDisplay();
      updateKnowledgeList();
      
      // Add event listeners
      document.querySelectorAll('.menu-item[data-panel]').forEach(item => {
        item.addEventListener('click', function() {
          document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
          this.classList.add('active');
          const panel = this.getAttribute('data-panel');
          showPanel(panel);
        });
      });
      
      // Initialize chat scroll position
      const chatArea = document.getElementById('chatArea');
      chatArea.scrollTop = chatArea.scrollHeight;
      
      // Add double-click to close sidebar
      mainContent.addEventListener('dblclick', function(e) {
        if (window.innerWidth <= 1024 && sidebar.classList.contains('active')) {
          toggleSidebar();
          e.stopPropagation();
        }
      });

      // Check for voice support
      checkVoiceSupport();
      
      // Update streak counter
      updateStreak();
    });
    
    // Check if voice recognition is supported
    function checkVoiceSupport() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        voiceBtn.disabled = true;
        voiceBtn.title = "Voice input not supported in your browser";
      }
    }
    
    // Toggle sidebar
    function toggleSidebar() {
      sidebar.classList.toggle('active');
      overlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
      
      if (window.innerWidth > 1024) {
        if (sidebar.classList.contains('active')) {
          mainContent.style.marginLeft = '280px';
        } else {
          mainContent.style.marginLeft = '0';
        }
      }
    }
    
    // Toggle knowledge panel
    function toggleKnowledgePanel() {
      knowledgePanel.classList.toggle('active');
      updateStatsDisplay();
      updateKnowledgeList();
    }
    
    // Show different panels
    function showPanel(panel) {
      if (panel === 'chat') {
        knowledgePanel.classList.remove('active');
      } else if (panel === 'knowledge' || panel === 'stats') {
        toggleKnowledgePanel();
      }
    }
    
    // Update stats display
    function updateStatsDisplay() {
      document.getElementById('statKnowledge').textContent = stats.knowledge;
      document.getElementById('statInteractions').textContent = stats.interactions;
      document.getElementById('statStreak').textContent = stats.streak;
      
      const progress = Math.min(stats.knowledge / 50 * 100, 100);
      document.getElementById('progressFill').style.width = `${progress}%`;
      document.getElementById('progressPercent').textContent = `${Math.round(progress)}%`;
    }
    
    // Update knowledge list
    function updateKnowledgeList() {
      const listContainer = document.getElementById('knowledgeList');
      listContainer.innerHTML = '';
      
      if (Object.keys(brain).length === 0) {
        listContainer.innerHTML = '<div style="padding: 0.75rem; text-align: center; color: var(--text-dim);">No knowledge yet</div>';
        return;
      }
      
      Object.entries(brain).forEach(([question, answer]) => {
        const item = document.createElement('div');
        item.className = 'knowledge-item';
        item.innerHTML = `
          <div><strong>Q:</strong> ${question}</div>
          <div><strong>A:</strong> ${answer}</div>
        `;
        listContainer.appendChild(item);
      });
    }
    
    // Update daily streak
    function updateStreak() {
      const today = new Date().toDateString();
      const lastInteraction = stats.lastInteraction ? new Date(stats.lastInteraction).toDateString() : null;
      
      if (lastInteraction === today) return;
      
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      yesterday.toDateString();
      
      if (lastInteraction === yesterday.toDateString()) {
        stats.streak++;
      } else if (lastInteraction && lastInteraction !== today) {
        stats.streak = 1;
      }
      
      stats.lastInteraction = new Date().toISOString();
      updateLocalStorage();
      updateStatsDisplay();
    }
    
    // Toggle theme
    function toggleTheme() {
      const currentTheme = document.body.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.body.setAttribute('data-theme', newTheme);
      localStorage.setItem('edithTheme', newTheme);
      updateThemeIcon();
    }
    
    // Update theme icon
    function updateThemeIcon() {
      const icon = document.querySelector('#themeToggle i');
      const text = document.querySelector('#themeToggle span');
      if (document.body.getAttribute('data-theme') === 'light') {
        icon.classList.remove('fa-moon');
        icon.classList.add('fa-sun');
        text.textContent = 'Dark Mode';
      } else {
        icon.classList.remove('fa-sun');
        icon.classList.add('fa-moon');
        text.textContent = 'Light Mode';
      }
    }
    
    // Clear chat
    function clearChat() {
      document.getElementById('chatArea').innerHTML = '';
      addMessage('ai', 'Chat history cleared.');
    }
    
    // Handle key press
    function handleKeyPress(e) {
      if (e.key === 'Enter') {
        respond();
      }
    }
    
    // Insert command
    function insertCommand(cmd) {
      userInput.value = cmd;
      userInput.focus();
    }
    
    // Show typing indicator
    function showTypingIndicator() {
      if (isTyping) return;
      
      const chatArea = document.getElementById("chatArea");
      const typingElement = document.createElement("div");
      typingElement.className = "ai-message";
      typingElement.id = "typingIndicator";
      typingElement.innerHTML = '<div class="typing-indicator"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>';
      chatArea.appendChild(typingElement);
      chatArea.scrollTop = chatArea.scrollHeight;
      isTyping = true;
    }
    
    // Hide typing indicator
    function hideTypingIndicator() {
      const typingElement = document.getElementById("typingIndicator");
      if (typingElement) {
        typingElement.remove();
      }
      isTyping = false;
    }
    
    // Add message to chat
    function addMessage(sender, text) {
      const chatArea = document.getElementById("chatArea");
      const messageElement = document.createElement("div");
      messageElement.className = `${sender}-message`;
      
      const now = new Date();
      const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
      messageElement.innerHTML = `
        <div class="message-content">${text}</div>
        <div class="message-time">${timeString}</div>
      `;
      
      chatArea.appendChild(messageElement);
      chatArea.scrollTop = chatArea.scrollHeight;
      
      if (sender === 'user') {
        stats.interactions++;
        updateLocalStorage();
        updateStreak();
      }
    }
    
    // Voice input
    function startVoiceInput() {
      if (isListening) {
        stopVoiceInput();
        return;
      }
      
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      
      if (!SpeechRecognition) {
        addMessage('ai', 'Voice input is not supported in your browser.');
        return;
      }
      
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      
      recognition.onstart = () => {
        isListening = true;
        voiceBtn.classList.add('voice-active');
        addMessage('ai', 'Listening... Speak now.');
        sendBtn.disabled = true;
      };
      
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        userInput.value = transcript;
      };
      
      recognition.onerror = (event) => {
        let message = 'Error occurred in recognition: ';
        switch(event.error) {
          case 'no-speech':
            message += 'No speech was detected.';
            break;
          case 'audio-capture':
            message += 'No microphone was found or access was denied.';
            break;
          case 'not-allowed':
            message += 'Permission to use microphone was denied.';
            break;
          default:
            message += event.error;
        }
        addMessage('ai', message);
        stopVoiceInput();
      };
      
      recognition.onend = () => {
        if (isListening) {
          stopVoiceInput();
          if (userInput.value.trim()) {
            setTimeout(() => {
              respond();
            }, 500);
          }
        }
      };
      
      try {
        recognition.start();
      } catch (e) {
        addMessage('ai', 'Error starting voice recognition: ' + e.message);
        stopVoiceInput();
      }
    }
    
    // Stop voice input
    function stopVoiceInput() {
      if (recognition) {
        recognition.stop();
      }
      isListening = false;
      voiceBtn.classList.remove('voice-active');
      sendBtn.disabled = false;
    }
    
    // Main response function
    function respond() {
      const input = userInput.value.trim();
      userInput.value = "";
      
      if (!input) return;
      
      addMessage('user', input);
      showTypingIndicator();
      
      setTimeout(() => {
        hideTypingIndicator();
        processInput(input);
      }, 500 + Math.random() * 1000);
    }
    
    // Process user input
    async function processInput(input) {
      const lowerInput = input.toLowerCase();
      
      if (lowerInput === 'help') {
        addMessage('ai', `
          <strong>Available Commands:</strong><br><br>
          <strong>teach: question => answer</strong> - Teach me something new<br>
          <strong>list</strong> - List all my knowledge<br>
          <strong>joke</strong> - Tell a random joke<br>
          <strong>search: query</strong> - Search the web for information<br>
          <strong>help</strong> - Show this help message
        `);
        return;
      }
      
      if (lowerInput === 'list') {
        if (Object.keys(brain).length === 0) {
          addMessage('ai', 'I don\'t have any knowledge yet. Teach me something!');
        } else {
          let knowledgeList = '<strong>My Knowledge:</strong><br><br>';
          knowledgeList += Object.entries(brain).map(([q, a]) => 
            `<strong>Q:</strong> ${q}<br><strong>A:</strong> ${a}<br>`
          ).join('<br>');
          addMessage('ai', knowledgeList);
        }
        return;
      }
      
      if (lowerInput === 'joke') {
        const jokes = [
          "Why don't scientists trust atoms? Because they make up everything!",
          "Did you hear about the mathematician who's afraid of negative numbers? He'll stop at nothing to avoid them!",
          "Why don't skeletons fight each other? They don't have the guts!"
        ];
        const joke = jokes[Math.floor(Math.random() * jokes.length)];
        addMessage('ai', joke);
        return;
      }
      
      if (lowerInput.startsWith('teach:')) {
        const parts = input.replace('teach:', '').split('=>').map(p => p.trim());
        if (parts.length === 2 && parts[0] && parts[1]) {
          const [question, answer] = parts;
          brain[question.toLowerCase()] = answer;
          stats.knowledge = Object.keys(brain).length;
          updateLocalStorage();
          addMessage('ai', `Learned: <strong>"${question}"</strong> → <strong>"${answer}"</strong>`);
          updateKnowledgeList();
        } else {
          addMessage('ai', 'Please use the correct format: <code>teach: question => answer</code>');
        }
        return;
      }
      
      if (lowerInput.startsWith('search:')) {
        const query = input.replace('search:', '').trim();
        if (!query) {
          addMessage('ai', 'Please provide a search query after "search:"');
          return;
        }
        
        addMessage('ai', `Searching the web for: <strong>${query}</strong>...`);
        try {
          const result = await fetchDuckDuckGoAnswer(query);
          if (result) {
            let response = `<strong>Web result for "${query}":</strong><br><br>`;
            if (result.AbstractText) {
              response += result.AbstractText;
              if (result.AbstractURL) {
                response += `<br><br><a href="${result.AbstractURL}" target="_blank">Read more</a>`;
              }
            } else if (result.RelatedTopics && result.RelatedTopics.length > 0) {
              response += result.RelatedTopics[0].Text;
              if (result.RelatedTopics[0].FirstURL) {
                response += `<br><br><a href="${result.RelatedTopics[0].FirstURL}" target="_blank">Read more</a>`;
              }
            } else {
              response += "No direct answer found. Try rephrasing your query.";
            }
            addMessage('ai', response);
          } else {
            addMessage('ai', 'Sorry, I couldn\'t find any results for that query.');
          }
        } catch (error) {
          addMessage('ai', 'Error fetching web results. Please try again later.');
          console.error('Search error:', error);
        }
        return;
      }
      
      if (brain[lowerInput]) {
        addMessage('ai', brain[lowerInput]);
        return;
      }
      
      // If we don't know the answer, offer to search the web
      addMessage('ai', 
        `I don't know the answer to that yet. You can:<br>
        1. Teach me: <code>teach: ${input} => the correct answer</code><br>
        2. Search the web: <code>search: ${input}</code>`
      );
    }
    
    // Fetch answer from DuckDuckGo Instant Answer API
    async function fetchDuckDuckGoAnswer(query) {
      try {
        stats.webQueries++;
        updateLocalStorage();
        
        const response = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1&skip_disambig=1`);
        
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Fetch error:', error);
        return null;
      }
    }
    
    // Update local storage
    function updateLocalStorage() {
      localStorage.setItem('edithBrain', JSON.stringify(brain));
      localStorage.setItem('edithStats', JSON.stringify(stats));
      updateStatsDisplay();
    }
  </script>
</body>
</html>